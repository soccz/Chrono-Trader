# 연구 일지 및 방법론 발전 과정

이 문서는 'Crypto Predictor' 프로젝트의 핵심 방법론이 초기 아이디어 단계에서부터 현재의 하이브리드 아키텍처에 이르기까지 어떻게 발전했는지를 추적합니다. 이 기록은 주요 아키텍처 결정의 배경과 저희의 고민 과정을 담고 있습니다.

## 1. 초기 모델: Transformer-Conditioned GAN

프로젝트는 **'트랜스포머-조건부 생성적 적대 신경망(Transformer-Conditioned GAN)'** 이라는 정교하고 새로운 아키텍처에서 시작되었습니다.

-   **핵심 아이디어**: 트랜스포머 인코더를 사용하여 시계열 데이터의 풍부한 시간적 문맥을 학습하고, 이 문맥을 GAN 디코더(생성자)의 조건으로 제공하여 현실적인 미래 예측 패턴을 생성합니다.
-   **강점**: 단순 예측을 넘어, 학습된 패턴에 기반한 생성적 접근법을 취했다는 점에서 이미 강력한 시작점이었습니다.

## 2. 1단계: 논문화를 위한 방법론 정립

학술 논문으로 발전시키는 것을 목표로, 초기 구현에서 **'재현성'과 '방법론적 타당성'** 을 보장하기 위해 몇 가지 공식화 작업이 필요함을 확인했습니다.

### 2.1. 유사도 측정: Euclidean Distance → DTW

-   **초기 상태**: '후발주 찾기(Pattern Following)' 전략에서 두 패턴의 유사도를 측정하기 위해 '유클리드 거리'를 사용했습니다.
-   **문제점**: 유클리드 거리는 패턴의 형태가 같더라도 시간 축에서 약간의 뒤틀림(shift)이 있으면 두 패턴이 매우 다르다고 판단하는 한계가 있었습니다.
-   **해결책**: 시계열 데이터 유사도 측정의 학술적 표준인 **DTW(Dynamic Time Warping)** 로 교체했습니다. 이를 통해 패턴 매칭 과정의 신뢰도와 강건함을 크게 향상시켰습니다.

### 2.2. 모델 아키텍처 명세화

-   **초기 상태**: `HybridModel`이 구현은 되어 있었으나, 정확한 아키텍처가 코드 내에 명시적으로 문서화되어 있지 않았습니다.
-   **문제점**: 논문은 모델 아키텍처를 다른 연구자가 이해할 수 있도록 명확하게 설명해야 합니다.
-   **해결책**: 데이터 흐름을 분석하여 아키텍처를 **'Transformer-Conditioned GAN'** 으로 공식 명명하고, `HybridModel` 클래스에 상세한 설명(docstring)을 추가하여 아키텍처를 코드 상에 명세화했습니다.

### 2.3. 스크리너 로직 공식화

-   **초기 상태**: '주도주'를 선별하는 로직에 최소 거래대금(예: `100,000,000`원)이 '매직 넘버'로 하드코딩되어 있었습니다.
-   **문제점**: '매직 넘버'는 중요한 실험 파라미터를 코드 속에 숨겨 재현성을 저해합니다.
-   **해결책**: 최소 거래대금 임계값을 `config.py` 파일의 `SCREENER_MIN_VOLUME_KRW` 라는 명시적인 파라미터로 옮겨, 실험 조건을 명확히 정의했습니다.

## 3. 새로운 아이디어: CNN의 도입과 해석 가능성

**"시계열 패턴을 이미지로 간주하면 어떨까?"** 라는 창의적인 아이디어가 제시되었습니다. 이는 CNN(Convolutional Neural Networks)의 강력한 성능을 활용할 수 있는 새로운 길을 열었습니다.

-   **핵심 아이디어**: CNN은 이미지의 국소적인 픽셀 패턴을 인식하는 데 매우 강력하며, 이 강점을 시계열 데이터의 단기적인 패턴(motif)을 찾는 데 동일하게 적용할 수 있습니다.
-   **해석 가능성의 발견**: CNN을 사용하면 **CAM 또는 Grad-CAM** 같은 설명가능 AI(XAI) 기법을 적용할 수 있습니다. 이를 통해 모델이 예측을 내릴 때 과거 데이터의 **'어느 부분'** 을 가장 중요하게 보았는지 시각적으로 확인할 수 있습니다. 이는 금융 AI의 '블랙박스' 문제를 해결할 수 있는, 이 연구의 매우 중요한 기여 지점이 될 수 있습니다.

## 4. 현재 아키텍처: 두 가지 CNN 접근법을 위한 통합 모델

이 새로운 아이디어는 "CNN을 어떻게 적용하는 것이 최선인가?"라는 중요한 연구 질문으로 이어졌습니다.

-   **접근법 A: 1D CNN 직접 적용**: 1차원 시계열 데이터에 1D CNN을 직접 적용하여 국소적인 시간 패턴(예: 급등, 급락)을 추출합니다.
    -   *장점*: 빠르고 직관적이며, 복잡한 데이터 변환 과정이 없습니다.
    -   *단점*: 시간적으로 멀리 떨어진 데이터 간의 복잡한 관계를 놓칠 수 있습니다.

-   **접근법 B: 2D CNN + 이미지 변환**: GAF(Gramian Angular Field) 등의 기법으로 시계열을 2D 이미지로 변환 후, 2D CNN을 적용합니다. 이미지의 공간적 패턴을 통해 복잡한 시간적 상관관계를 포착할 수 있습니다.
    -   *장점*: 더 복잡하고 거시적인 패턴을 학습할 잠재력이 있습니다.
    -   *단점*: 데이터 변환의 복잡성과 추가적인 계산 비용이 발생합니다.

이 연구 질문을 탐구하기 위해, `HybridModel`을 두 접근법을 모두 지원하도록 리팩토링했습니다.

-   **구현**: `config.CNN_MODE` 설정을 '1D' 또는 '2D'로 변경하여, 트랜스포머와 함께 동작하는 병렬 CNN 경로를 동적으로 선택할 수 있습니다.
-   **다음 단계**: 이 유연한 아키텍처를 통해, 어떤 접근법이 더 우수한 성능을 보이는지 엄격한 비교 실험(Phase 2)을 수행하여 논문의 깊이를 더할 수 있습니다.

## 5. 2단계: 시스템 고도화 및 안정성 확보 (현재 진행 중)

이 단계에서는 기존 시스템의 예측 성능을 강화하고, 새로운 '급등 포착' 기능을 도입하며, 시스템의 전반적인 안정성과 지능을 향상시키는 데 집중했습니다.

### 5.1. 메인 모델 (시스템 1) 개선

*   **TA-Lib → pandas-ta 전환**: `TA-Lib` 빌드 문제로 인해 `pandas-ta` 라이브러리로 전환하여 기술 지표 계산의 안정성을 확보했습니다.
*   **WGAN-GP 도입**: 기존 GAN의 학습 불안정성을 개선하고, 더 다양한 미래 가격 경로(확률 분포)를 생성하기 위해 WGAN-GP 구조를 도입했습니다. (`models/critic.py`, `training/trainer.py` 수정)
*   **'Crypto S&P 500' 지수 및 알파/베타 도입**: 시장 전체 흐름을 더 정확히 반영하고자, 기존 시장 지수를 '시가총액 가중 평균' 방식으로 고도화했습니다. 이 '메인 추세선'을 기준으로 개별 코인의 시장 민감도(베타)와 고유 수익률(알파)을 계산하여 모델의 입력 특징으로 추가했습니다. (`data/preprocessor.py` 수정)
*   **패턴 추종 로직 개선**: `PATTERN_LOOKBACK_HOURS`를 6시간에서 24시간으로 확장하여 패턴 매칭의 신뢰도를 높였습니다. (`utils/config.py`, `data/preprocessor.py` 수정)

### 5.2. 새로운 기능: 급등 포착 모델 (시스템 2) 도입

*   **목표 정의**: '10% 이상 상승 (6시간 이내)'을 급등으로 정의하고, 이를 예측하는 독립적인 시스템을 구축했습니다.
*   **데이터 전처리**: 급등 예측을 위한 새로운 특징(Volume Spikes, BB Squeeze, ROC 등)과 라벨링 로직을 구현했습니다. (`data/preprocessor.py` 수정)
*   **모델 훈련**: XGBoost 기반의 분류 모델을 훈련하는 `training/pump_trainer.py`를 개발했습니다.
*   **예측 모듈**: 훈련된 모델을 사용하여 급등 코인을 예측하는 `inference/pump_predictor.py`를 개발했습니다.
*   **통합**: `main.py`에 `train-pump` 및 `find-pumps` 모드를 추가하고, `daily` 워크플로우에 급등 포착 로직을 통합했습니다.

### 5.3. 시스템 지능 및 안정성 고도화 (사용자 통찰력 반영)

이 단계는 사용자님의 핵심적인 통찰력을 반영하여 시스템의 근본적인 설계 철학을 개선했습니다.

*   **'시장 추세'를 모델의 학습 변수로 통합**:
    *   **문제점 인식**: 기존에는 '시장 추세'를 외부 필터(하락장에서 매수 추천 제거)로 사용하여 모델의 예측을 강제로 제한했습니다. 이는 시장과 반대로 움직이는 '진짜 기회'를 놓칠 수 있다는 사용자님의 지적을 받았습니다。
    *   **해결책**: '시장 지수 수익률'을 시스템 1(하이브리드 모델)과 시스템 2(XGBoost 모델) 모두의 학습 변수(Feature)로 직접 포함시켰습니다. (`data/preprocessor.py` 수정)
    *   **결과**: 이제 모델은 예측 시 시장 상황을 스스로 고려하여, 필요하다면 시장 추세에 역행하는 추천(예: 하락장에서의 매수)도 지능적으로 생성할 수 있게 되었습니다。
*   **하드코딩된 '시장 추세 필터' 제거**: 모델이 시장 상황을 직접 학습하므로, `inference/recommender.py`에서 기존의 규칙 기반 필터 로직을 완전히 제거했습니다。
*   **급등 예측 모델의 다중 분류 전환**:
    *   **문제점 인식**: 초기 급등 모델은 '급등한다/안 한다'의 이진 분류만 가능하여, '얼마나 급등할지'에 대한 정보가 부족했습니다。
    *   **해결책**: 급등 라벨을 4개의 구간(0: 10% 미만, 1: 10-15%, 2: 15-20%, 3: 20% 이상)으로 세분화하고, XGBoost 모델을 다중 분류(Multi-class Classification) 모델로 재훈련했습니다. (`data/preprocessor.py`, `training/pump_trainer.py`, `inference/pump_predictor.py`, `main.py` 수정)
    *   **결과**: 이제 급등 예측은 '급등 확률 분포' 형태로 제공되어, 사용자에게 훨씬 더 상세하고 유용한 정보를 제공합니다。
*   **모델 저장/로딩 방식 개선 (안정성 확보)**:
    *   **문제점 인식**: 하이퍼파라미터 튜닝 후 모델 구조가 변경될 때, `model_config.json`과 `model.pth` 파일 간의 불일치로 인해 `size mismatch` 오류가 반복적으로 발생했습니다。
    *   **해결책**: PyTorch 모델 저장 방식을 '파라미터만 저장'(`state_dict`)에서 **'모델 전체 객체 저장'**으로 변경했습니다. (`training/trainer.py` 수정)
    *   **결과**: 예측 시 `model_config.json`에 의존하지 않고, 저장된 모델 파일 자체에서 구조와 파라미터를 완벽하게 불러오므로, 구조 불일치로 인한 오류가 원천적으로 차단되어 시스템의 안정성이 극대화되었습니다. (`inference/predictor.py` 수정)
*   **급등 예측 결과 CSV 저장**: `main.py`에 `save_pump_predictions_to_csv` 함수를 추가하여 급등 예측 결과도 CSV로 저장할 수 있도록 했습니다.

### 5.4. 최종 감사 및 확인

*   모든 코드 수정 사항에 대한 감사를 완료했으며, 최종 시스템 설명과 완벽하게 일치함을 확인했습니다.

## 6. 향후 연구 과제 (Future Research Tasks)

이 프로젝트는 지속적인 연구와 개선을 통해 더욱 발전할 수 있습니다.

*   **급등 모델 미세 조정(Fine-tuning) 로버스트화**: 현재 급등 모델의 일일 미세 조정은 데이터 부족 시 건너뛰어지는 문제가 있습니다. 미세 조정 데이터 생성 로직을 더 유연하게 만들거나, 미세 조정이 불가능할 경우에 대한 처리 방식을 명확히 하여 모델이 항상 최신 데이터로 업데이트될 수 있도록 개선이 필요합니다.
*   **최소 신뢰도 필터 도입**: 모델의 예측 신뢰도가 매우 낮을 경우, 아예 추천을 하지 않는 '최소 신뢰도' 필터를 도입하여 보수적인 리스크 관리를 강화할 수 있습니다.
*   **다중 타임프레임 예측**: 현재 1시간 단위의 단기 예측을 넘어, 4시간, 일(Day) 단위의 중장기적 예측 모델을 추가 개발하여 사용자의 투자 스타일에 맞는 다양한 전략적 추천을 제공하는 방향으로 확장을 고려할 수 있습니다.
*   **어텐션 메커니즘 고도화**: Transformer의 핵심인 Q, K, V(Query, Key, Value) Attention 메커니즘에 도메인 지식을 주입하는 연구를 통해, 특정 변수나 특정 시간대의 중요도를 조절하여 모델의 예측 성능과 해석 가능성을 동시에 향상시킬 수 있습니다。
*   **CNN 활용 확장**: 현재 1D CNN을 넘어, 시계열 데이터를 2D 이미지로 변환 후 2D CNN을 적용하는 방식(GAF 등)을 탐구하여 더 복잡하고 거시적인 패턴을 학습할 잠재력을 탐색할 수 있습니다。
